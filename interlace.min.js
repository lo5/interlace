(function(){var _,coalesceScopes,collectLocals,combineScopes,createLocalScope,createScope,escodegen,esprima,interlace,purge,traverse,slice=[].slice;_=require("lodash");esprima=require("esprima");escodegen=require("escodegen");collectLocals=function(node,opts){var declaration;if(!node){return null}switch(node.type){case"VariableDeclaration":if(opts.preserveLocals){return function(){var j,len,ref,results;ref=node.declarations;results=[];for(j=0,len=ref.length;j<len;j++){declaration=ref[j];if(declaration.type==="VariableDeclarator"&&declaration.id.type==="Identifier"){results.push({type:"preserve",name:declaration.id.name})}}return results}()}break;case"FunctionDeclaration":if(node.id.type==="Identifier"){return[{type:"preserve",name:node.id.name}]}break;case"ForStatement":return collectLocals(node.init,opts);case"ForInStatement":case"ForOfStatement":return collectLocals(node.left,opts)}return null};createScope=function(block,opts){var declaration,declarations,j,k,len,len1,node,ref,symbols;symbols=[];ref=block.body;for(j=0,len=ref.length;j<len;j++){node=ref[j];if(declarations=collectLocals(node,opts)){for(k=0,len1=declarations.length;k<len1;k++){declaration=declarations[k];symbols.push(declaration)}}}return _.indexBy(symbols,function(symbol){return symbol.name})};combineScopes=function(scope1,scope2){var name,scope,symbol;scope={};for(name in scope1){symbol=scope1[name];scope[name]=symbol}for(name in scope2){symbol=scope2[name];scope[name]=symbol}return scope};coalesceScopes=function(scopes){var currentScope,i,j,len,name,scope,symbol;currentScope={};for(i=j=0,len=scopes.length;j<len;i=++j){scope=scopes[i];if(i===0){for(name in scope){symbol=scope[name];currentScope[name]=symbol}}else{for(name in scope){symbol=scope[name];currentScope[name]=null}}}return currentScope};createLocalScope=function(node,opts){var j,len,localScope,param,ref;localScope=createScope(node.body,opts);if(node.type==="FunctionExpression"||node.type==="FunctionDeclaration"){ref=node.params;for(j=0,len=ref.length;j<len;j++){param=ref[j];if(param.type==="Identifier"){localScope[param.name]={type:"preserve",name:param.name}}}}return localScope};traverse=function(opts,scopes,parentScope,parent,node,f){var child,currentScope,isNewScope,key;isNewScope=node.type==="FunctionExpression"||node.type==="FunctionDeclaration";if(isNewScope){scopes.push(createLocalScope(node,opts));currentScope=coalesceScopes(scopes)}else{currentScope=parentScope}if(_.isArray(node)){key=node.length;while(key--){child=node[key];if(child!==null&&_.isObject(child)&&!_.isFunction(child)){traverse(opts,scopes,currentScope,node,child,f);f(currentScope,node,key,child)}}}else{for(key in node){child=node[key];if(child!==null&&_.isObject(child)&&!_.isFunction(child)){traverse(opts,scopes,currentScope,node,child,f);f(currentScope,node,key,child)}}}if(isNewScope){scopes.pop()}};purge=function(parent,i){if(_.isArray(parent)){return parent.splice(i,1)}else if(_.isObject(parent)){return delete parent[i]}};interlace=function(symbols,javascript,opts){var globalScope,program,rootScope;if(opts==null){opts={}}program=esprima.parse(javascript);rootScope=createScope(program,opts);globalScope=combineScopes(rootScope,symbols);traverse(opts,[globalScope],globalScope,null,program,function(currentScope,parent,key,node){var declarations,first,ref,ref1,rest,symbol;if(node.type==="VariableDeclaration"){declarations=node.declarations.filter(function(declaration){var symbol;if(declaration.type==="VariableDeclarator"&&declaration.id.type==="Identifier"){if(symbol=currentScope[declaration.id.name]){return symbol.type==="preserve"}else{return true}}else{return true}});if(declarations.length===0){purge(parent,key)}else{node.declarations=declarations}}else if(node.type==="Identifier"){if(parent.type==="VariableDeclarator"&&key==="id"){return}if(parent.type==="Property"&&key==="key"){return}if(key==="property"){return}if(!(symbol=currentScope[node.name])){return}if(symbol.type!=="qualify"){return}parent[key]={type:"MemberExpression",computed:false,object:{type:"Identifier",name:symbol.object},property:{type:"Identifier",name:(ref=symbol.property)!=null?ref:node.name}}}else if(node.type==="CallExpression"){if(node.callee.type!=="Identifier"){return}if(!(symbol=currentScope[node.callee.name])){return}if(symbol.type!=="invoke"){return}if(!(node["arguments"].length>0)){return}ref1=node["arguments"],first=ref1[0],rest=2<=ref1.length?slice.call(ref1,1):[];node.callee={type:"MemberExpression",computed:false,object:first,property:{type:"Identifier",name:symbol.property||node.callee.name}};node["arguments"]=rest}});return escodegen.generate(program)};module.exports=interlace}).call(this);